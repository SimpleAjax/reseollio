services:
  postgres:
    image: postgres:15-alpine
    container_name: reseolio-loadtest-postgres
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: reseolio
    # Expose port even if just for debugging, but internal network handles comms
    ports:
      - "5433:5432" 
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d reseolio"]
      interval: 2s
      timeout: 5s
      retries: 10
    volumes:
      - postgres-test-data:/var/lib/postgresql/data

  loadtest:
    build:
      context: .
      dockerfile: Dockerfile.loadtest
    container_name: reseolio-loadtest
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./test-results:/data
    environment:
      - NODE_ENV=test
      - RESEOLIO_LOG_LEVEL=info
      - RESEOLIO_DB=postgres://user:password@postgres:5432/reseolio
    command: >
      sh -c "
        echo '==> Starting Reseolio server...' &&
        reseolio &
        sleep 2 &&
        echo '==> Running multi-worker load test...' &&
        tsx tests/load/02-multi-worker.ts &&
        echo '==> Load test complete!'
      "

  # Individual test services for running specific tests
  throughput-test:
    build:
      context: .
      dockerfile: Dockerfile.loadtest
    container_name: reseolio-throughput-test
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./test-results:/data
    environment:
      - NODE_ENV=test
      - RESEOLIO_LOG_LEVEL=info
      - RESEOLIO_DB=postgres://user:password@postgres:5432/reseolio
    command: >
      sh -c "
        reseolio &
        sleep 2 &&
        tsx tests/load/01-throughput.ts
      "

  multi-worker-test:
    build:
      context: .
      dockerfile: Dockerfile.loadtest
    container_name: reseolio-multi-worker-test
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./test-results:/data
    environment:
      - NODE_ENV=test
      - RESEOLIO_LOG_LEVEL=info
      - RESEOLIO_DB=postgres://user:password@postgres:5432/reseolio
    command: >
      sh -c "
        reseolio &
        sleep 2 &&
        tsx tests/load/02-multi-worker.ts
      "

  retry-storm-test:
    build:
      context: .
      dockerfile: Dockerfile.loadtest
    container_name: reseolio-retry-storm-test
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./test-results:/data
    environment:
      - NODE_ENV=test
      - RESEOLIO_LOG_LEVEL=info
      - RESEOLIO_DB=postgres://user:password@postgres:5432/reseolio
    command: >
      sh -c "
        reseolio &
        sleep 2 &&
        tsx tests/load/03-retry-storm.ts
      "

  # Run all load tests sequentially
  all-tests:
    build:
      context: .
      dockerfile: Dockerfile.loadtest
    container_name: reseolio-all-tests
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./test-results:/data
    environment:
      - NODE_ENV=test
      - RESEOLIO_LOG_LEVEL=info
      - RESEOLIO_DB=postgres://user:password@postgres:5432/reseolio
    command: >
      sh -c "
        reseolio &
        sleep 2 &&
        echo '========== THROUGHPUT TEST ==========' &&
        tsx tests/load/01-throughput.ts &&
        echo '' &&
        echo '========== MULTI-WORKER TEST ==========' &&
        tsx tests/load/02-multi-worker.ts &&
        echo '' &&
        echo '========== RETRY STORM TEST ==========' &&
        tsx tests/load/03-retry-storm.ts &&
        echo '' &&
        echo '========== ALL TESTS COMPLETE =========='
      "

  # Development/debug service - keeps container alive for manual testing
  dev:
    build:
      context: .
      dockerfile: Dockerfile.loadtest
    container_name: reseolio-dev
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./test-results:/data
      - ./tests:/app/tests  # Mount tests for live editing
    environment:
      - NODE_ENV=test
      - RESEOLIO_LOG_LEVEL=debug
      - RUST_LOG=debug
      - RESEOLIO_ADDR=0.0.0.0:50051
      - RESEOLIO_DB=postgres://user:password@postgres:5432/reseolio
    stdin_open: true
    ports:
      - "50051:50051"
    tty: true
    command: >
      sh -c "
        echo '==> Starting Reseolio server with DEBUG logging...' &&
        export RUST_LOG=debug &&
        reseolio &
        sleep 2 &&
        echo '==> Server ready! Container will stay alive.' &&
        echo '==> Database: postgres://user:password@postgres:5432/reseolio' &&
        echo '==> Run tests with: tsx tests/load/02-multi-worker.ts' &&
        echo '==> View logs with: docker logs -f reseolio-dev' &&
        echo '' &&
        tail -f /dev/null
      "

volumes:
  postgres-test-data:
